<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bookshelf Scanner</title>
    <link rel="stylesheet" href="styles.css?v=10">
    <!-- No need for Tesseract anymore - using OpenAI Vision API -->
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <div class="header-text">
                    <h1>üìö Bookshelf Scanner</h1>
                    <p>Scan and catalog your books with ease</p>
                </div>
                <div class="header-actions">
                    <div id="userInfo" class="user-info" style="display: none;">
                        <span id="userEmail"></span>
                        <button id="logoutBtn" class="btn btn-secondary logout-btn">
                            <span class="icon">üö™</span>
                            Logout
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Authentication Section -->
        <section class="auth-section" id="authSection">
            <div class="auth-container">
                <div class="auth-tabs">
                    <button id="loginTab" class="auth-tab-btn active">Sign In</button>
                    <button id="signupTab" class="auth-tab-btn">Sign Up</button>
                </div>

                <!-- Login Form -->
                <div id="loginForm" class="auth-form">
                    <h2>Welcome Back</h2>
                    <p>Sign in to access your bookshelf scanner</p>
                    <form id="loginFormElement">
                        <div class="form-group">
                            <label for="loginEmail">Email</label>
                            <input type="email" id="loginEmail" required>
                        </div>
                        <div class="form-group">
                            <label for="loginPassword">Password</label>
                            <input type="password" id="loginPassword" required>
                        </div>
                        <button type="submit" class="btn btn-primary auth-btn">
                            <span class="icon">üîë</span>
                            Sign In
                        </button>
                    </form>
                    <div id="loginError" class="error-message"></div>
                </div>

                <!-- Signup Form -->
                <div id="signupForm" class="auth-form" style="display: none;">
                    <h2>Create Account</h2>
                    <p>Join us to start scanning your bookshelf</p>
                    <form id="signupFormElement">
                        <div class="form-group">
                            <label for="signupEmail">Email</label>
                            <input type="email" id="signupEmail" required>
                        </div>
                        <div class="form-group">
                            <label for="signupPassword">Password</label>
                            <input type="password" id="signupPassword" required minlength="6">
                        </div>
                        <div class="form-group">
                            <label for="confirmPassword">Confirm Password</label>
                            <input type="password" id="confirmPassword" required>
                        </div>
                        <button type="submit" class="btn btn-primary auth-btn">
                            <span class="icon">üìù</span>
                            Create Account
                        </button>
                    </form>
                    <div id="signupError" class="error-message"></div>
                </div>

                <!-- Email Verification Message -->
                <div id="verificationMessage" class="verification-message" style="display: none;">
                    <h3>üìß Check Your Email</h3>
                    <p>We've sent a verification link to your email address. Please check your inbox and click the link to verify your account.</p>
                    <button id="resendVerification" class="btn btn-secondary">Resend Verification Email</button>
                </div>
            </div>
        </section>

        <main id="mainApp" style="display: none;">
            <!-- Navigation Tabs -->
            <nav class="main-nav">
                <div class="nav-tabs">
                    <button id="scannerTab" class="nav-tab active">
                        <span class="icon">üì∑</span>
                        Scanner
                    </button>
                    <button id="libraryTab" class="nav-tab">
                        <span class="icon">üìö</span>
                        Library
                    </button>
                    <button id="photosTab" class="nav-tab">
                        <span class="icon">üì∏</span>
                        Photos
                    </button>
                </div>
                <div class="connection-status" id="connectionStatus">
                    <span class="status-indicator offline" id="statusIndicator">‚óè</span>
                    <span class="status-text" id="statusText">Connecting...</span>
                </div>
            </nav>

            <!-- Scanner Section -->
            <section id="scannerSection" class="main-section">
                <!-- Camera Section -->
            <section class="camera-section">
                <div class="input-options">
                    <div class="input-tabs">
                        <button id="cameraTab" class="tab-btn active">üì∑ Live Camera</button>
                        <button id="photoTab" class="tab-btn">üìÅ Upload Photo</button>
                    </div>
                </div>

                <!-- Camera View -->
                <div id="cameraView" class="input-view">
                    <div class="camera-container">
                        <video id="video" autoplay playsinline></video>
                        <canvas id="canvas" style="display: none;"></canvas>
                        <div class="camera-overlay" id="cameraOverlay">
                            <div class="detection-overlay" id="detectionOverlay"></div>
                        </div>
                    </div>
                    
                    <div class="camera-controls">
                        <button id="startCamera" class="btn btn-primary">
                            <span class="icon">üì∑</span>
                            Start Camera
                        </button>
                        <button id="toggleDetection" class="btn btn-secondary" disabled>
                            <span class="icon">üîç</span>
                            Start Detection
                        </button>
                        <button id="stopCamera" class="btn btn-danger" disabled>
                            <span class="icon">‚èπÔ∏è</span>
                            Stop Camera
                        </button>
                    </div>
                </div>

                <!-- Photo Upload View -->
                <div id="photoView" class="input-view" style="display: none;">
                    <div class="upload-container">
                        <input type="file" id="photoInput" accept="image/*" style="display: none;">
                        <div class="upload-area" id="uploadArea">
                            <div class="upload-content">
                                <span class="upload-icon">üì∑</span>
                                <h3>Upload Bookshelf Photo</h3>
                                <p>Click to select or drag and drop an image of your bookshelf</p>
                                <button class="btn btn-primary" onclick="document.getElementById('photoInput').click()">
                                    <span class="icon">üìÅ</span>
                                    Select Photo
                                </button>
                            </div>
                        </div>
                        <div class="uploaded-image-container" id="uploadedImageContainer" style="display: none;">
                            <img id="uploadedImage" alt="Uploaded bookshelf">
                            <div class="image-overlay" id="imageOverlay"></div>
                        </div>
                    </div>
                    
                    <div class="photo-controls" style="display: none;" id="photoControls">
                        <button id="analyzePhoto" class="btn btn-primary">
                            <span class="icon">üîç</span>
                            Analyze Bookshelf
                        </button>
                        <button id="clearPhoto" class="btn btn-secondary">
                            <span class="icon">üóëÔ∏è</span>
                            Clear Photo
                        </button>
                    </div>
                </div>
            </section>

            <!-- Processing Section -->
            <section class="processing-section" style="display: none;">
                <div class="processing-container">
                    <div class="captured-image-container">
                        <img id="capturedImage" alt="Captured book">
                    </div>
                    <div class="processing-status">
                        <div class="spinner"></div>
                        <p id="processingText">Processing image...</p>
                    </div>
                </div>
            </section>

            <!-- Results Section -->
            <section class="results-section" style="display: none;">
                <div class="book-details" id="bookDetails" style="display: none;">
                    <h3>Book Information</h3>
                    <div class="book-info">
                        <div class="book-cover">
                            <img id="bookCover" alt="Book cover">
                        </div>
                        <div class="book-metadata">
                            <h4 id="bookTitle"></h4>
                            <p class="author" id="bookAuthor"></p>
                            <p class="isbn" id="bookISBN"></p>
                            <p class="published" id="bookPublished"></p>
                            <p class="description" id="bookDescription"></p>
                        </div>
                    </div>
                    <div class="book-actions">
                        <button id="addToLibrary" class="btn btn-success">
                            <span class="icon">‚ûï</span>
                            Add to Library
                        </button>
                        <button id="scanAnother" class="btn btn-primary">
                            <span class="icon">üîÑ</span>
                            Scan Another
                        </button>
                    </div>
                </div>

                <div class="extracted-text" id="extractedText" style="display: none;">
                    <h3>Extracted Text</h3>
                    <div class="text-content">
                        <textarea id="ocrResult" readonly></textarea>
                    </div>
                    <button id="searchBooks" class="btn btn-primary">
                        <span class="icon">üîç</span>
                        Search for Book
                    </button>
                </div>
            </section>

            </section>

            <!-- Library Section -->
            <section id="librarySection" class="main-section" style="display: none;">
                <div class="library-section">
                <div class="library-header">
                    <div class="library-title-section">
                        <h3>My Library (<span id="bookCount">0</span> books)</h3>
                        <div class="library-search">
                            <input type="text" id="librarySearch" placeholder="Search books by title or author..." class="search-input">
                            <span class="search-icon">üîç</span>
                        </div>
                    </div>
                    <div class="library-actions">
                        <button id="exportLibrary" class="btn btn-secondary">
                            <span class="icon">üì§</span>
                            Export Library
                        </button>
                        <button id="clearLibrary" class="btn btn-danger">
                            <span class="icon">üóëÔ∏è</span>
                            Clear Library
                        </button>
                    </div>
                </div>
                <div class="library-grid" id="libraryGrid">
                    <div class="empty-library">
                        <p>No books scanned yet. Start by scanning your first book!</p>
                    </div>
                </div>
                </div>
            </section>

            <!-- Photos Section -->
            <section id="photosSection" class="main-section" style="display: none;">
                <div class="photos-section">
                    <div class="photos-header">
                        <h3>My Photos (<span id="photoCount">0</span> photos)</h3>
                        <p>All your scanned bookshelf photos</p>
                    </div>
                    <div class="photos-grid" id="photosGrid">
                        <div class="empty-photos">
                            <p>No photos scanned yet. Start by scanning your first bookshelf!</p>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, sendEmailVerification } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, doc, setDoc, getDoc, addDoc, query, where, getDocs, orderBy } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';
        
        // Your Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyBuP5Hyl5Zgu4BUIj72cyOOE-FEnK5D8Mo",
            authDomain: "bookshelf-c2c6d.firebaseapp.com",
            projectId: "bookshelf-c2c6d",
            storageBucket: "bookshelf-c2c6d.firebasestorage.app",
            messagingSenderId: "1011814965647",
            appId: "1:1011814965647:web:88cecfbeeefab0f4f42bfa",
            measurementId: "G-TYB42BZ80J"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        
        // Make Firebase services available globally
        window.auth = auth;
        window.db = db;
        window.storage = storage;
        window.signInWithEmailAndPassword = signInWithEmailAndPassword;
        window.createUserWithEmailAndPassword = createUserWithEmailAndPassword;
        window.signOut = signOut;
        window.onAuthStateChanged = onAuthStateChanged;
        window.sendEmailVerification = sendEmailVerification;
        
        // Firestore functions
        window.collection = collection;
        window.doc = doc;
        window.setDoc = setDoc;
        window.getDoc = getDoc;
        window.addDoc = addDoc;
        window.query = query;
        window.where = where;
        window.getDocs = getDocs;
        window.orderBy = orderBy;
        
        // Storage functions
        window.ref = ref;
        window.uploadBytes = uploadBytes;
        window.getDownloadURL = getDownloadURL;
        window.deleteObject = deleteObject;
    </script>
    
    <!-- HEIC to JPEG conversion libraries -->
    <script src="https://cdn.jsdelivr.net/npm/heic2any@0.0.4/dist/heic2any.min.js" 
            onerror="console.error('Failed to load heic2any library')"></script>
    <!-- Note: heic-convert and heic-js libraries are not available via CDN, skipping them -->
    <script src="script.js?v=15"></script>
</body>
</html>
